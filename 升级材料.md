#### NeoX到Messiah导出工具

​         项目需要把基于NeoX引擎的老游戏相关资源和场景导入到Messiah中。老游戏资源老旧，当时制作时的中间文件(如fbx等文件)也不存在，美术无法直接将这些文件导入到Messiah中使用。同时组内美术的场景工作流程是在UE中搭建场景，然后导出到Messiah中。老游戏中十多个场景（最后只选定五个场景）重新在UE中搭建然后导出到Messiah中显然会花费大量的美术人力，拖慢项目进度。  

​        独立开发了一套NeoX到Messiah的导出工具。工具将NeoX中模型，地形，场景信息，动画等各种资源导出到Messiah中。主要工作如下：

##### 确定两个引擎坐标系差异

​       NeoX坐标是标准左手坐标系，Messiah是右手坐标系。确定坐标系差异后，决定需要改变的坐标轴。对于当前两个引擎的坐标系来说，Y和Z轴一一对应后，只要将NeoX坐标系X轴取反即可将两坐标系对应起来。对于位置等信息，X左边简单取反即可。对于旋转相关的计算，简单取反会导致矩阵的负定等问题，具体解决方式后续说明

#### 模型相关资源输出

##### 1. Mesh资源的输出。

1. 顶点的位置信息：首先根据两个引擎的缩放比例，对顶点的位置信息进行直接缩放。然后根据坐标系差异，进行变换，将位置信息用Messiah坐标系表示。
2. 法线相关信息：首先根据坐标系差异，进行Normal和Tangent转化，然后叉积方式计算Binormal。
3. 如果三角面环绕顺序不一致，进行三角面环绕顺序的调整。

##### 2. 材质信息输出：

 	   策划说明导出后效果没有特殊要求。以前光照计算简单，材质导出简单处理，全部映射为PBR相关材质。

##### 3. 贴图输出：

​       NeoX中资源贴图多数为TGA格式，与Messiah相符。读取贴图信息，输出到Messiah即可。对于非TGA格式文件，转化后输出。

#### 地形相关资源输出：

​        NeoX以trunk形式管理地形高度数据。Messiah则需要合成整块高度数据。加载NeoX各个地形trunk的高度数据后，根据trunk分布，将高度数据进行合并。

​       合成地形高度数据后，由于两坐标系X轴取向相反，需要调整高度数据。采用的方法是对调高度图X轴方向上的高度信息。然后根据两边地形的比例，确定Messiah里输出高度图的尺寸，采用二维差值的方法输出高度图信息。对于控制地表混合权重的权重图，采用相同的方法处理。

#### 场景生成：

​        导出资源后，进行场景构建。场景构建涉及到两个引擎下场景中物体的Transform变化。由上可知，确定两场景的坐标系差异后，可以通过翻转X轴来确定Messiah物理的Transform。简单翻转X可以用于位置等简单信息。对于旋转，简单翻转表示旋转的X轴会导致矩阵负定问题。所以旋转数据的导出需要特殊处理。

​        NeoX中的Transform以矩阵形式提供。读取Transform后，从矩阵中提取位置，缩放，和旋转信息。位置X方向上取反即可，缩放根据预先确定的比例修改。旋转则需要特殊处理。

​		旋转有三种表示方式：欧拉角，矩阵和四元数。欧拉角有万向锁问题，不适合作中间数据。直接翻转旋转矩阵的X轴又会导致矩阵负定等问题，所以通过四元数来处理导出旋转问题。四元数可以理解为用旋转轴和旋转角度表示的旋转，通过变化旋转轴和旋转角度来进行旋转转换，具体操作如下：

1. 将旋转从矩阵表示形式转化为四元数表示形式。
2. 根据四元数表示的旋转意义，从四元数中提取旋转轴，将四元数的旋转轴从NeoX坐标系转到Messiah坐标系来表示。
3. 从四元数中提取旋转角度，根据手系朝向确定Messiah中绕旋转轴顺时针或者逆时针旋转的角度
4. 根据转换后的旋转轴和旋转角度，组合成新的四元数。
5. 将四元数转化为用矩阵形式

最后，将变换后的位置，旋转和缩放重新组合，即可得到Messiah中的对应物件的Transform。

#### 动画数据的导出

​        跟模型一样，老游戏中只有NeoX格式下的动画数据，动画编辑无法进行导出操作，并且新游戏中对物件骨骼数量，骨骼名称和骨骼间的架构都有要求，需要特定工具对动画数据进行导出。动画可以分为三要素：蒙皮信息，骨骼架构信息，每帧动画数据。动画数据中骨骼Transform的处理方式跟导出场景时物件Transform的处理方式基本一致，但是还需要额外考虑骨骼间的父子关系信息。具体处理方式如下：

1. 加载NeoX中的相关文件，得到骨骼间的父子层级关系和TPos下各个骨骼的位置，根据父子层级关系建立BoneTree。
2. 加载NeoX中的动画数据。
3. 平展动画数据。动画数据存储的是关键帧里每一根骨骼相对于其父骨骼的Transform，即每根骨骼Transform的描述都是基于其父骨骼空间。要将每一根骨骼的Transform从其父骨骼空间中的表示转化为该骨骼在模型空间中的表示。根据骨骼父子间层级关系，从根骨骼开始，依次将动画数据中骨骼的Transform矩阵相乘，得到每根骨骼在模型空间中的位置。
4. 得到骨骼在模型空间中Transform后，运用上面转换场景物件Transform相同的方法，分别转换位置和缩放信息。对于旋转，处理方式也是转换为四元数进行转变。得到该骨骼在Messiah坐标系下在模型空间中的位置。
5. 运用同样的处理步骤转换其父骨骼，得到父骨骼在Messiah坐标系下在模型空间中的位置。
6. 将子骨骼在模型空间中的Transform转换为其在父骨骼空间中的Transform，该Transform即为该骨骼在该帧下的Transform。
7. skeleton和skin文件转换输出。

​        NeoX到Messiah的导出工具，快速将老引擎中的相关资源导入到了Messiah中。对应场景，美术只需要放置特效，进行lightmap烘焙等微调工作即可。对于模型，不用重新做动画等资源，节省了大量的美术模型相关的人力，导出的场景及动画模型已经随H67怀旧服外放。同时导出中采用的坐标系间Transform转换的方式，可以通用于各种坐标系有差异的编辑器引擎间的资源导入导出。

#### 新轻量级草地系统

2.新轻量级草地系统：新的instance管理方式，基于距离的密度衰减管理系统。

   开发基于密度图的实时生成并管理instance的轻量级草地系统。采用特殊的插片形式和效果极佳的地表融合方式，有效避免插片模型顶部视角时的穿帮问题。同时引入基于Grid的instance管理系统。根据格子切分空间并管理草地的instance。加入基于距离的密度衰减系统，基于距离计算格子内的显示等级，并根据显示等级决定显示的instance 数量。当显示等级变化引起instance数量变化时，添加类似于lod切换的dither机制来保证不会有突变问题

#### H67植被系统

##### 植被流程

1. 与TA配合，确定了SpeedTree制作植被的方式。

 	2. 与TA配合测试多种球形法线的制作方式，确定植被模型的法线制作方式。

##### 基于球谐函数编码的自遮挡阴影信息

​       植被由于其复杂的拓扑结构，自遮挡阴影信息对植被的表现尤为重要。受限于移动平台性能，场景中阴影的渲染距离一般比较近。当没有阴影时，植被渲染时就没有相应的自遮挡信息，导致植被表现效果较差。同时有无阴影时的表现相差很大。

​       考虑到阴影信息和光照方向息息相关，而光照方向可以看成是分布在球面上的函数。基于此，自遮挡的阴影信息也可以看做是分布在球面上的函数。球面函数可以投影到球谐函数上，生成一组投影系数。投影系数和球谐函数正交基组合，可以得到原函数。因此，可以预计算植被模型的自遮挡信息，然后投影到球谐函数上，得到球谐系数，然后在光照计算中用球谐系数还原自遮挡阴影信息。具体流程如下：

1. 基于移动平台性能考量，采用二阶球谐函数来进行阴影遮挡信息的编码
2. 计算遮挡信息。加载植被模型后，对于模型上的每个顶点，向球面的各个方向发射射线，计算该顶点的遮挡信息。
3. 遮挡信息投影。得到遮挡信息后，选定球谐函数组做为正交基，将遮挡信息表示为这组正交基的线性组合，线性组合的系数即为遮挡信息的球谐系数。
4. 将二级球谐系数（共四个）存储到植被的顶点色中。
5. 重建遮挡信息。shader中计算时，将光照方向转到模型空间中，根据球谐系数和模型空间中光照方向，重建该光照方向下的遮挡信息用于阴影计算。

​        基于球谐函数编码的自遮挡阴影信息的方法，离线计算遮挡信息，编码在模型的顶点色中，以较小的开销，还原了模型的遮挡阴影信息，提升了植被在无阴影状态下的效果表现。

##### 基于枢轴点计算的植被风动流程

​       良好的植被随风摆动效果能提升场景。传统的方式一般是采用三角函数进行随机扰动，不能体现风向，且效果单一。基于枢轴点植被风动通过指定植被枝干的枢轴点及枝干的朝向，运算中通过风向及枝干方向计算枝干扰动方向，绕枢轴点转动，能表现出比较自然的植被风动效果。该方案基于UE的枢轴点工具来指定枢轴点位置和枝干朝向，同时考虑移动平台限制，枢轴点数量限制为128以下，并且对UE中的方案进行简化，提取图中数据，进行预计算，避免多次采图，能流畅的运行在移动平台之上。该方案具体如下：

1. 美术通过枢轴点插件分割模型枝干和层级关系，指定模型的枢轴点位置和枝干朝向。模型制作完毕后输出对应的枢轴点位置图和朝向图。
2. UE插件导出模型时，进行数据的预处理。提取生成的枢轴点图和朝向图的数据，同时将提取出来的数据进行预计算图中，而是以uniform buffer的形式提供给shader。
3. 修改Mesh数据。原版需要根据贴图中采出来的数据，在VS中进行复杂的运算，以判断层级并进行下一次采图。新流程中将顶点的枢轴点数据和朝向数据的索引以类似骨骼索引的形式存储在顶点中，并在mesh中记录层级数量，配合上面uniform buffer提供枢轴点数据和朝向数据， VS中读取相应的数据更加简单。
4. 简化VS中的计算逻辑，去掉非必要计算，将计算动画所需要的VS中采图的数量降低为一次。

以该方法实现的风动系统，真机实测，在移动平台，对帧率基本无影响，耗电在40msu以下，可以运行于移动平台。



2. Dissolving新方案。
      老方案的dissolving在主RT上全屏绘制alpha test，会带来极大的性能开销，导致开镜时有明显的卡顿问题。新方案对dissolving物体新建尺寸比较小的RT，将需要dissolving的物体绘制到该RT上，后续再融合到主RT上。通过缩小RT的大小，减小了全屏alpha test带来的性能开销。即使新方案需要切换RT，性能也远远优于老方案。真机实测60帧时普遍能带来5帧以上的性能提升。