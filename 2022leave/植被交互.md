### 静态风场：

​        良好的植被随风摆动效果能提升场景表现。传统方式一般是采用三角函数对顶点进行随机扰动。这种扰动不能体现风向，效果单一，并且不能用于枝干的扰动。

​		实现一种能体现风向的，枝干也能随风摆动的自然的风动效果。

**实现方式**

1. 对树进行分解。分成主干，枝干和树叶部分，之间有层级关系，相互连接，类似动画的骨骼树。每个分支都可以看做是一个独立个体，随风摆动。

2. 枝干的运动方式。

   对于一个枝干的运动，有两个关键要素：枝干朝向和枝干的枢轴点。枝干会绕着枢轴点运动。枝干的运动通过四元数来描述，因为其有比较直观的物理意义。

   + 旋转轴：根据风向和枝干朝向，可以计算出这个枝干的旋转轴，即旋转轴=cross(枝干朝向，风向)。
   + 旋转角度：物理意义上来讲，旋转角度跟风力大小息息相关。风力的大小由一张风力图提供，每帧采风力图，作为旋转的角度
   + 根据层级关系，一层层的向下计算，知道得到最后的位置。

3. 美术编辑方式。美术需要将植被模型分簇，为每一簇模型指定一个朝向和旋转时候的枢轴点。最后将每一簇模型组合起来形成父子关系。编辑采用的是UE的枢轴点工具，编辑完毕后会输出两张图，一张是枝干朝向图，另一张是枢轴点位置图。基于性能考虑：
   + 枝干分簇上限是128，就是最多有128个数轴点。
   + 因为上述限制，输出的图一般比较小。所以对输出的图进行预处理，数据提取出来，以uniformBuffer的形式提供给shader计算使用。
   + 修改顶点格式，采用类似骨骼动画的形式。每个顶点都会记录影响自己的枝干朝向和数轴点位置信息的索引，计算时通过索引从UniformBuffer中提取相关数据。
4. 不足的地方：
   + 运动的逼真程度跟分簇的合理性和分簇的数量息息相关。近看可能会发现一整簇随风飘动的现象。
   + 要求枝干的有比较规律的形状，即尽量不要弯弯曲曲的，否则可能会有脱离现象
   + 植被的最后一级是面片，没有相应的风动逻辑，lod切换时可能会有突变。
5. 性能：大部分的运算在VS中，且限定了风动模型的顶点数量，较远处的billboard不风动，性能在可接受的合理范围内。真机实测电量开销20-50左右

### 动态风场

参考链接：https://developer.nvidia.com/gpugems/gpugems/part-vi-beyond-triangles/chapter-38-fast-fluid-dynamics-simulation-gpu

动态风场采用速度场来描述，每一点由方向和大小两个属性。每帧求解正确的速度场。速度场的计算采用描述流体运动的Navier-Stokes方程来计算。并有如下假设：

+ 流体是不可压缩的
+ 流体是homogeneous(均质的)，流体密度是常量

总结起来：流体密度在时间和空间上都是常量

如果速度和压力在初始时已知，那么流体的状态随时间的变化可以描述为：
$$
\frac{\partial{\pmb u}}{\partial{t}} = -(\pmb u\cdot \nabla)\pmb u - \frac{1}{\rho}\nabla p + \nu\nabla^2\pmb u + \pmb F\\
\nabla \cdot \pmb u = 0
$$
分解为xy方向时：
$$
\frac{\partial{u}}{\partial{t}} = -(\pmb u\cdot \nabla)u - \frac{1}{\rho}\nabla p + 
\nu\nabla^2u + F_x\\
\frac{\partial{v}}{\partial{t}} = -(\pmb u\cdot \nabla)v - \frac{1}{\rho}\nabla p + 
\nu\nabla^2v + F_y\\
$$
需要求解是三个变量u，v，p，有三个公式。公式中的四项分别是：

+ Advection(平流)：流体的Advection会向流体的方向运送物体，同样的运送物体自己。描述的是每个位置的物理量随速度的流动
+ Pressure(压力)：当有外力施加时，外力并不会立即传输到流体的各个区域。分子会相互挤压，形成压力。压力会带来流体的加速运动
+ Diffusion(扩散)：有些流体流动的块，有些慢。粘性来衡量这一参数，即流体有多抗拒流动。抗拒流动的结果就是流体中动量的扩散，也就是速度的扩散
+ 外力作用。带来流体加速。

**求解过程**：

Helmholtz-Hodge Decomposition Theorem：一个向量场可以分解为其他两个向量场的和：即一个散度为0的向量场和一个标量场的梯度场。
$$
\pmb w = \pmb u + \nabla p
$$
Navier-Stockes 方程求解分为三步：**Advection， diffusion， force application**，计算后得到的向量场散度不为0的向量场**w**。方程要求最后得到一个散度为0的向量场**u**，所以根据Helmholtz-Hodge分解理论，将得到的向量场减去压力的梯度即可得到散度为0的向量场**u**。

对上面公式求散度，可以得到压力p的计算公式。
$$
\nabla \cdot\pmb w = \nabla \cdot(\pmb u) + \nabla^2p\\
\nabla \cdot u = 0\\
 \nabla^2p = \nabla \cdot w
$$
现在需要一种方式来计算向量场**w**。定义一个投影算子**P**。该算子将**w**投影为散度为0的向量场，即
$$
\pmb P \pmb w = \pmb P \pmb u + \pmb P(\nabla p)
$$
$$， 由于**u**就是散度为0的向量场，所以
$$
\pmb P \pmb w = \pmb P \pmb u
$$
可以推出得到 
$$
\pmb P(\nabla p)=0
$$
。带入完整公式：
$$
\pmb P \frac{\partial{\pmb u}}{\partial{t}} = \pmb P(-(\pmb u\cdot \nabla)\pmb u - \frac{1}{\rho}\nabla p + \nu\nabla^2\pmb u + \pmb F)
$$
由于左边**u**就是散度为0的向量场，所以左边可去掉投影算子**P**。对
$$
\nabla p
$$
的投影由上可知为0，最终可以得到
$$
\frac{\partial{\pmb u}}{\partial{t}} = \pmb P(-(\pmb u\cdot \nabla)\pmb u  + \nu\nabla^2\pmb u + \pmb F)
$$
从上述公式中我们从左往右分别计算Advection， Diffusion，force三项，得到一个有散度的速度场，然后对其进行投影，最终得到没有散度的向量场。最终的求解是通过迭代状态的改变来实现，也就是每一步有一个输入向量场，迭代后生成一个新的向量场。下面就是分别求解上面的三项。

+ **Advection**:

  根据速度和时间，可以算出流体移动的距离，
  $$
  r(t + \delta t) = r(t) + u(t)\delta t
  $$
  这个公式不适用于直接使用，主要原因有：

  + 当$\delta t$很大时，不稳定
  + 不适用于fragment shader计算。取得的是当前点的速度场，却要更新其他点的速度场。

  将公式稍微变形，得到
  $$
  q(x, t+\delta t) = q(x - u(x, t)\delta t, t)
  $$
  通过计算当前点在$\delta t$时间前的位置，拿到该位置的速度场的值作为当前点速度场的值。

+ **Viscous Diffusion**

  有粘性的物体会抵抗流动，这会导致速度的扩散。基于和Advection同样的计算考虑，公式如下
  $$
  \frac{\partial u} {\partial t} = \nu\nabla^2u\\
  u(x, t+\delta t) = u(x, t) + \nu \delta t\nabla^2u(x, t)
  $$
  简化后得到：
  $$
  (I - \nu\delta t\nabla^2u)u(x, t+\delta t) = u(x, t)
  $$
  是变形后的泊松方程。泊松方程通过Jaccobi 迭代的方式求解

#### 泊松方程求解：

laplacian算子的公式
$$
\nabla^2p = \frac{\partial^2 p}{\partial x^2} + \frac{\partial^2 p}{\partial y^2}\space \space \space \space \space \space\\
\nabla^2p = \frac{p_{i+1, j} + p_{i-1,j} + p_{i, j+1} + p_{i, j-1} - 4p_{i, j} }{(\delta x)^2}
$$
两个公式一个是连续化表示，一种是离散化表示。

Jacobi迭代的公式为：
$$
x^{k+1}_{i, j} = \frac{x^{k}_{i-1, j} + x^{k}_{i+1, j} + x^{k}_{i, j+1}+ x^{k}_{i, j-1} + \alpha b_{i, j}}{\beta}
$$
在压力的计算中，x代表压力，b代表$\nabla \cdot w$，即速度场的散度。 
$$
\alpha = (-x^2), \beta = 4
$$
在diffusion的计算中，x 和 b 都是 速度场，
$$
\alpha = (x^2)/(visicosity * dt), \beta = (4.0 + \alpha)
$$


### 求解流程

1. 对速度场和压力场分别建立两个frameBuffer，求解时用作ping-pong buffer。

2. 首先是boundary处理，图片拷贝，同时boundary处速度值取反。

3. 进行Advect操作。

4. 进行添加外力操作

5. 进行Diffusion操作。流体会赋予viscosity值，**根据其大小来决定是否进行Diffusion操作**。采用Jacobi iteration的方式求解，迭代次数可选。

6. 进行压力相关计算。前面几步后求得的场是有散度的，减去压力的梯度值之后得到的才是divergence free的速度场。根据公式
$$
   \nabla^2p = \nabla \cdot w
   $$
   进行求解。首先要根据当前计算出的速度场求得该速度场的散度，然后用Jacobi iteration进行求解。求得压力场后，根据公式
   $$
   \pmb w = \pmb u + \nabla p
   $$
   ，从当前速度场中减去压力的梯度值，求得最后的divergence free的速度场。**压力的计算可以选择要或者不要，同时求解压力迭代的次数也可以为了性能进行调整**
   
   离散的梯度，散度和Laplacian求解方式

​     	
$$
Gradient\space\space\space\space\space\space\space\space\space\space\space \nabla p = \lbrace \frac{\partial p}{\partial x}, \frac{\partial p}{\partial y}\rbrace\space\space\space\space\space\space\space\space\space\space\space\space\space\space \frac{p_{i+1, j}-p_{i-1, j} }{2\delta x}, \frac{p_{i, j+1}-p_{i, j-1} }{2\delta y}\\

Divergence\space\space\space\space\space\space\space\space\space\space\space \nabla\cdot u = \frac{\partial u}{\partial x} + \frac{\partial u}{\partial y} \space\space\space\space\space\space\space\space\space\space\space\space\space\space \frac{u_{i+1, j}-u_{i-1, j} }{2\delta x}+ \frac{u_{i, j+1}-u_{i, j-1} }{2\delta y}\\

Laplacian\space\space\space\space\space\space\space\space\space\space\space \nabla p =\frac{\partial^2 p}{\partial x^2}+ \frac{\partial^2 p}{\partial y^2}\space\space\space\space\space\space\space\space\space\space\space\space\space\space \frac{p_{i+1, j}+p_{i-1, j} - 2p_{i, j}}{(\delta x)^2}+\frac{p_{i, j+1}+p_{i, j-1} - 2p_{i, j} }{(\delta y)^2}
$$

### 性能：

这里的模拟在二维空间下，性能的大小跟RT的大小息息相关，另外也可以简化某些计算，比如Diffusion计算或者Pressure的计算完全不运行或者减少Jacobi迭代的次数，来达到移动平台能够运行的性能。

### 作用于植被：

运算时，根据植被当前位置取得动态风力的大小，与静态风力相结合，作用于植被运动。

### 不足：

1. 2D空间中模拟，没有高度信息，高度敏感的地方表现有些怪异。此外需要将开炮风动与移动风动的影响分开模拟。
2. 作用于植被时，没有找到适当的方法来描述回弹力的作用，植被在风动的相应不自然。